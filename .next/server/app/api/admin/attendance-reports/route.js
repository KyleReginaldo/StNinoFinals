(()=>{var e={};e.id=1205,e.ids=[1205],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},24467:()=>{},26723:(e,t,r)=>{"use strict";r.d(t,{_:()=>o});var s=r(92570);let n="https://ulntyefamkxkbynrugop.supabase.co",a=process.env.SUPABASE_SERVICE_ROLE_KEY;function o(){if(!n||!a)throw Error("Missing Supabase admin env. Set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY (server-only).");return(0,s.UU)(n,a,{auth:{autoRefreshToken:!1,persistSession:!1}})}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55591:e=>{"use strict";e.exports=require("https")},55961:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>m,routeModule:()=>u,serverHooks:()=>g,workAsyncStorage:()=>c,workUnitAsyncStorage:()=>p});var s={};r.r(s),r.d(s,{GET:()=>l});var n=r(43007),a=r(44360),o=r(98343),d=r(28142),i=r(26723);async function l(e){try{console.log("\uD83D\uDCCA Attendance Reports API called");let{searchParams:t}=new URL(e.url),r=t.get("startDate"),s=t.get("endDate"),n=t.get("studentId"),a=t.get("gradeLevel"),o=t.get("section");console.log("\uD83D\uDCC5 Date range:",{startDate:r,endDate:s,studentId:n,gradeLevel:a,section:o});let l=(0,i._)(),u=s?new Date(s):new Date,c=r?new Date(r):new Date;r||c.setDate(c.getDate()-30);let p=c.toISOString(),g=u.toISOString();console.log("\uD83D\uDD0D Querying students...");let{data:m,error:f}=await l.from("students").select("*").limit(1e3);if(f)return console.error("âŒ Error fetching students:",f),d.NextResponse.json({success:!1,error:`Failed to fetch students: ${f.message}`,data:null},{status:200});console.log(`âœ… Found ${m?.length||0} students`);let x=m||[];a&&"all"!==a&&(x=x.filter(e=>(e.grade_level||"").toString().toLowerCase()===a.toLowerCase())),o&&"all"!==o&&(x=x.filter(e=>(e.section||"").toString().toLowerCase()===o.toLowerCase())),console.log("\uD83D\uDD0D Querying attendance records from",p,"to",g);let{data:_,error:S}=await l.from("attendance_records").select("*").gte("scan_time",p).lte("scan_time",g).order("scan_time",{ascending:!0});if(S)return console.error("âŒ Error fetching attendance records:",S),d.NextResponse.json({success:!1,error:`Failed to fetch attendance records: ${S.message}`,data:null},{status:200});console.log(`âœ… Found ${_?.length||0} attendance records`);let h={};m&&m.forEach(e=>{let t=(e.student_id||e.student_number||e.id||"").toString().trim();t&&(h[t]={...e,fullName:`${e.first_name||e.firstName||""} ${e.last_name||e.lastName||""}`.trim()||e.name||"Unknown"})});let y=(_||[]).filter(e=>{let t=h[(e.student_id||"").toString().trim()];return void 0!==t}),v=y;n&&"all"!==n&&(v=y.filter(e=>(e.student_id||"").toString().trim()===n.toString().trim()));let w={};v.forEach(e=>{let t=(e.student_id||"").toString().trim(),r=h[t];if(!r)return;let s=r.student_id||r.student_number||t;w[s]||(w[s]={student:r,records:[],totalDays:0,present:0,absent:0,late:0,excused:0,percentage:0,dailyAttendance:{}}),w[s].records.push(e);let n=new Date(e.scan_time).toISOString().split("T")[0],a=(e.status||"Present").toLowerCase(),o=(e.scan_type||"timein").toLowerCase();("timein"===o||"time_in"===o)&&("present"===a?(w[s].present++,w[s].dailyAttendance[n]="PR"):"absent"===a?(w[s].absent++,w[s].dailyAttendance[n]="AC"):"late"===a?(w[s].late++,w[s].dailyAttendance[n]="LA"):"excused"===a&&(w[s].excused++,w[s].dailyAttendance[n]="EX"),w[s].totalDays++)});let A=Object.values(w).map(e=>{let t=e.totalDays||1;return e.percentage=Math.round(e.present/t*100),{studentId:e.student.student_id||e.student.student_number||e.student.id,studentName:e.student.fullName,gradeLevel:e.student.grade_level||e.student.gradeLevel||"N/A",section:e.student.section||"N/A",totalDays:e.totalDays,present:e.present,absent:e.absent,late:e.late,excused:e.excused,percentage:e.percentage,dailyAttendance:e.dailyAttendance,records:e.records}}),E=A.length||1,R=A.reduce((e,t)=>e+t.present,0),b=A.reduce((e,t)=>e+t.absent,0),D=A.reduce((e,t)=>e+t.late,0),L=A.reduce((e,t)=>e+t.totalDays,0),P=L>0?Math.round(R/L*100):0,N=L>0?Math.round(b/L*100):0,k=null;n&&"all"!==n&&(k=A.find(e=>(e.studentId||"").toString()===n.toString()));let q=[...new Set((m||[]).map(e=>e.grade_level||e.gradeLevel).filter(Boolean))],C=[...new Set((m||[]).map(e=>e.section).filter(Boolean))];return console.log(`ðŸ“ˆ Returning data: ${A.length} students, ${L} total days, ${P}% present`),d.NextResponse.json({success:!0,data:{general:{totalStudents:E,totalPresent:R,totalAbsent:b,totalLate:D,totalDays:L,presentPercentage:P,absentPercentage:N},students:A,selectedStudent:k,dateRange:{start:p,end:g},filters:{gradeLevels:q.sort(),sections:C.sort()}}},{status:200})}catch(e){return console.error("Error in attendance reports API:",e),d.NextResponse.json({success:!1,error:e?.message||"Internal server error",data:null},{status:200})}}let u=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/admin/attendance-reports/route",pathname:"/api/admin/attendance-reports",filename:"route",bundlePath:"app/api/admin/attendance-reports/route"},resolvedPagePath:"D:\\capstone\\StNinoFinals\\app\\api\\admin\\attendance-reports\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:c,workUnitAsyncStorage:p,serverHooks:g}=u;function m(){return(0,o.patchFetch)({workAsyncStorage:c,workUnitAsyncStorage:p})}},61419:()=>{},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[6535,2038,2570],()=>r(55961));module.exports=s})();