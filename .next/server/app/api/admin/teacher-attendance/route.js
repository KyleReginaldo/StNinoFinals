(()=>{var e={};e.id=8180,e.ids=[8180],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},8041:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>u,serverHooks:()=>g,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>p});var a={};r.r(a),r.d(a,{GET:()=>d});var s=r(43007),n=r(44360),o=r(98343),i=r(28142),c=r(26723);async function d(e){try{let{searchParams:t}=new URL(e.url),r=t.get("startDate"),a=t.get("endDate"),s=t.get("teacherId"),n=(0,c._)(),o=a?new Date(a):new Date,d=r?new Date(r):new Date;r||d.setDate(d.getDate()-30);let u=d.toISOString(),l=o.toISOString(),{data:p,error:g}=await n.from("teachers").select("*").limit(1e3);g&&console.error("Error fetching teachers:",g);let{data:h,error:m}=await n.from("attendance_records").select("*").gte("scan_time",u).lte("scan_time",l).order("scan_time",{ascending:!0});if(m)return console.error("Error fetching attendance records:",m),i.NextResponse.json({success:!1,error:m.message,data:null},{status:200});let f={},_={};p&&p.forEach(e=>{let t=(e.teacher_id||e.id||"").toString().trim(),r=(e.email||"").toString().trim().toLowerCase(),a=`${e.first_name||""} ${e.last_name||""}`.trim()||e.name||"Unknown";t&&(f[t]={...e,fullName:a}),r&&(f[r]={...e,fullName:a});let s=(e.rfid_card||e.rfidCard||e.rfid_tag||e.rfidTag||"").toString().trim().toUpperCase().replace(/\s+/g,"");s&&(_[s]={...e,fullName:a},f[s]={...e,fullName:a})}),console.log(`ðŸ“Š Found ${p?.length||0} teachers`),console.log(`ðŸ”‘ Teacher RFID map has ${Object.keys(_).length} entries:`,Object.keys(_));let S=(h||[]).filter(e=>{let t=(e.student_id||"").toString().trim(),r=(e.rfid_card||e.rfidCard||e.rfid_tag||e.rfidTag||"").toString().trim().toUpperCase().replace(/\s+/g,"");return void 0!==f[t]||!!r&&void 0!==_[r]});console.log(`âœ… Found ${S.length} teacher attendance records out of ${h?.length||0} total records`);let x={};S.forEach(e=>{let t=(e.student_id||"").toString().trim(),r=(e.rfid_card||e.rfidCard||e.rfid_tag||e.rfidTag||"").toString().trim().toUpperCase().replace(/\s+/g,""),a=f[t];if(!a&&r&&(a=_[r]||f[r]),!a){console.log(`âš ï¸ Could not find teacher for record: student_id=${t}, rfid=${r}`);return}let s=a.teacher_id||a.id||t;x[s]||(x[s]={teacher:a,records:[],totalDays:0,present:0,absent:0,late:0,percentage:0,dailyAttendance:{}}),x[s].records.push(e);let n=new Date(e.scan_time).toISOString().split("T")[0],o=e.status||"Present",i=e.scan_type||"timein";"Present"===o||"timein"===i?(x[s].present++,x[s].dailyAttendance[n]="PR"):"Absent"===o?(x[s].absent++,x[s].dailyAttendance[n]="AC"):"Late"===o&&(x[s].late++,x[s].dailyAttendance[n]="LA"),x[s].totalDays++});let y=Object.values(x).map(e=>{let t=e.totalDays||1;return e.percentage=Math.round(e.present/t*100),{teacherId:e.teacher.teacher_id||e.teacher.id,teacherName:e.teacher.fullName,subject:e.teacher.subject||e.teacher.subjects||e.teacher.subject_taught||"N/A",totalDays:e.totalDays,present:e.present,absent:e.absent,late:e.late,percentage:e.percentage,dailyAttendance:e.dailyAttendance,records:e.records}}),A=y.length||1,b=y.reduce((e,t)=>e+t.present,0),v=y.reduce((e,t)=>e+t.absent,0),E=y.reduce((e,t)=>e+t.totalDays,0),w=E>0?Math.round(b/E*100):0,D=E>0?Math.round(v/E*100):0,R=null;return s&&(R=y.find(e=>(e.teacherId||"").toString()===s.toString())),i.NextResponse.json({success:!0,data:{general:{totalTeachers:A,totalPresent:b,totalAbsent:v,totalDays:E,presentPercentage:w,absentPercentage:D},teachers:y,selectedTeacher:R,dateRange:{start:u,end:l}}},{status:200})}catch(e){return console.error("Error in teacher attendance API:",e),i.NextResponse.json({success:!1,error:e?.message||"Internal server error",data:null},{status:200})}}let u=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/admin/teacher-attendance/route",pathname:"/api/admin/teacher-attendance",filename:"route",bundlePath:"app/api/admin/teacher-attendance/route"},resolvedPagePath:"D:\\capstone\\StNinoFinals\\app\\api\\admin\\teacher-attendance\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:l,workUnitAsyncStorage:p,serverHooks:g}=u;function h(){return(0,o.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:p})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},24467:()=>{},26723:(e,t,r)=>{"use strict";r.d(t,{_:()=>o});var a=r(92570);let s="https://ulntyefamkxkbynrugop.supabase.co",n=process.env.SUPABASE_SERVICE_ROLE_KEY;function o(){if(!s||!n)throw Error("Missing Supabase admin env. Set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY (server-only).");return(0,a.UU)(s,n,{auth:{autoRefreshToken:!1,persistSession:!1}})}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55591:e=>{"use strict";e.exports=require("https")},61419:()=>{},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[6535,2038,2570],()=>r(8041));module.exports=a})();